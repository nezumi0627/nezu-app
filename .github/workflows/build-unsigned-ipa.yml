name: Build Unsigned IPA

on:
  push:
    branches: [main, master]
    paths:
      - "test-app/**"
      - ".github/workflows/build-unsigned-ipa.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ===========================================================
  # Step 1: Check if version changed
  # ===========================================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      build_number: ${{ steps.check.outputs.build_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for version change
        id: check
        run: |
          set -e
          V_CONFIG="test-app/Version.xcconfig"

          # 現在のバージョンを取得
          CURRENT_VERSION=$(grep 'MARKETING_VERSION' "$V_CONFIG" | cut -d'=' -f2 | xargs)
          CURRENT_BUILD=$(grep 'CURRENT_PROJECT_VERSION' "$V_CONFIG" | cut -d'=' -f2 | xargs)

          echo "Current version: $CURRENT_VERSION (build $CURRENT_BUILD)"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$CURRENT_BUILD" >> $GITHUB_OUTPUT

          # workflow_dispatch の場合は常にビルド
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger — building"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 前回のコミットのバージョンを取得
          if git show HEAD~1:"$V_CONFIG" > /dev/null 2>&1; then
            PREV_VERSION=$(git show HEAD~1:"$V_CONFIG" | grep 'MARKETING_VERSION' | cut -d'=' -f2 | xargs)
            PREV_BUILD=$(git show HEAD~1:"$V_CONFIG" | grep 'CURRENT_PROJECT_VERSION' | cut -d'=' -f2 | xargs)
            echo "Previous version: $PREV_VERSION (build $PREV_BUILD)"

            if [ "$CURRENT_VERSION" != "$PREV_VERSION" ] || [ "$CURRENT_BUILD" != "$PREV_BUILD" ]; then
              echo "Version changed: $PREV_VERSION.$PREV_BUILD -> $CURRENT_VERSION.$CURRENT_BUILD"
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "Version unchanged — skipping build"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous commit for Version.xcconfig — building"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # ===========================================================
  # Step 2: Build (only if version changed)
  # ===========================================================
  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: macos-latest

    steps:
      # =========================================================
      # Checkout
      # =========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # =========================================================
      # Xcode
      # =========================================================
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Xcode info
        run: |
          xcodebuild -version
          swift --version || true

      # =========================================================
      # Cache
      # =========================================================
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: deriveddata-v2-${{ runner.os }}-${{ hashFiles('test-app/**/*.swift') }}
          restore-keys: |
            deriveddata-v2-${{ runner.os }}-

      # =========================================================
      # Build
      # =========================================================
      - name: Build unsigned app
        run: |
          set -euxo pipefail
          cd test-app

          # Detect Project or Workspace dynamically
          if ls *.xcworkspace >/dev/null 2>&1; then
            TARGET=$(ls -d *.xcworkspace | head -n1)
            SCHEME=$(xcodebuild -list -workspace "$TARGET" | awk '/Schemes:/ {getline; gsub(/^[ \t]+|[ \t]+$/, ""); print}')
            ARGS=(-workspace "$TARGET" -scheme "$SCHEME")
          else
            TARGET=$(ls -d *.xcodeproj | head -n1)
            SCHEME=$(xcodebuild -list -project "$TARGET" | awk '/Schemes:/ {getline; gsub(/^[ \t]+|[ \t]+$/, ""); print}')
            ARGS=(-project "$TARGET" -scheme "$SCHEME")
          fi

          echo "Building $TARGET with scheme $SCHEME"

          xcodebuild \
            "${ARGS[@]}" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            ONLY_ACTIVE_ARCH=YES \
            -quiet \
            build

      # =========================================================
      # Find App
      # =========================================================
      - name: Locate .app
        id: find_app
        run: |
          set -e
          APP_PATH=$(find DerivedData -name "*.app" | head -n1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: .app not found in DerivedData"
            exit 1
          fi
          echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app: $APP_PATH"

      # =========================================================
      # Create IPA
      # =========================================================
      - name: Create IPA
        id: create_ipa
        run: |
          set -e
          APP_PATH="${{ steps.find_app.outputs.APP_PATH }}"
          APP_NAME=$(basename "$APP_PATH" .app)
          V="${{ needs.check-version.outputs.version }}"
          B="${{ needs.check-version.outputs.build_number }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          IPA_NAME="${APP_NAME}-v${V}-build${B}-${SHORT_SHA}.ipa"

          zip -qr "$IPA_NAME" Payload
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV
          echo "VERSION=$V" >> $GITHUB_ENV
          echo "BUILD_NUM=$B" >> $GITHUB_ENV
          echo "Created $IPA_NAME"

      # =========================================================
      # Verify IPA
      # =========================================================
      - name: Verify IPA
        run: |
          unzip -l "$IPA_NAME" | grep Payload

      # =========================================================
      # Metadata & Repository Update
      # =========================================================
      - name: Generate metadata & Update Repo
        run: |
          set -e
          IPA="$IPA_NAME"
          V="$VERSION"
          B="$BUILD_NUM"

          SIZE_BYTES=$(stat -f%z "$IPA")
          SIZE_HUMAN=$(du -h "$IPA" | cut -f1)
          SHA256=$(shasum -a 256 "$IPA" | awk '{print $1}')

          # URL エンコードされた URL も生成 (SideStore 直接リンク用)
          DIRECT_URL="https://github.com/${{ github.repository }}/releases/download/v${V}-build${B}/${IPA_NAME}"
          ENCODED_URL=$(echo -n "$DIRECT_URL" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")

          XCODE_VER=$(xcodebuild -version | head -n1)
          SWIFT_VER=$(swift --version 2>/dev/null | head -n1 || echo "unknown")
          SDK_VER=$(xcodebuild -showsdks 2>/dev/null | grep -i iphoneos | head -n1 | sed 's/.*iphoneos//' || echo "unknown")

          git log -10 --pretty=format:'- `%h` %ad **%an**: %s' --date=short > commits.md

          # リポジトリ JSON を更新
          python3 scripts/update_apps_json.py "$V" "$B" "$DIRECT_URL" "$SIZE_BYTES" "$SHA256"

          # リリース本文の作成 (ヒアドキュメントのインデントに注意)
          cat <<EOF > release-body.md
## Nezu App v${V} (Build ${B})

- **Version**: \`${V}\`
- **Build**: \`${B}\`
- **Commit**: \`${GITHUB_SHA}\`
- **Branch**: \`${GITHUB_REF_NAME}\`
- **Run**: #${GITHUB_RUN_NUMBER}
- **IPA File**: \`${IPA}\`
- **IPA Size**: ${SIZE_HUMAN} (${SIZE_BYTES} bytes)
- **IPA SHA256**: \`${SHA256}\`

### 📲 インストール (Source Repository)

> [!IMPORTANT]
> このアプリを常に最新の状態にポータルに保つには、以下のソースをインストーラーに追加することをお勧めします。

**SideStore / AltStore 用:**
\`\`\`text
https://nezumi0627.github.io/nezu-app/apps.json
\`\`\`

**LiveContainer 用:**
\`\`\`text
livecontainer://source?url=aHR0cHM6Ly9uZXp1bWkwNjI3LmdpdGh1Yi5pby9uZXp1LWFwcC9hcHBzLmpzb24=
\`\`\`

### 🏗️ 手動インストール (Copy & Paste)

> [!NOTE]
> 特別にこのバージョンのみをインストールしたい場合は、以下のURLをコピーしてブラウザ等で開いてください。

**SideStore 用:**
\`\`\`text
sidestore://install?url=${ENCODED_URL}
\`\`\`

### Build Environment

- **Xcode Version**: ${XCODE_VER}
- **iOS SDK Version**: ${SDK_VER}
- **Swift Version**: ${SWIFT_VER}

### Commits included in this build (latest 10)

$(cat commits.md)

**注意**: このIPAは署名無しです。公開リリース後に有効になります。
EOF

          # JSON メタデータの作成
          cat <<EOF > build-metadata.json
          {
            "version": "$V",
            "build": "$B",
            "ipa": "$IPA",
            "size_bytes": $SIZE_BYTES,
            "sha256": "$SHA256",
            "commit": "${GITHUB_SHA}",
            "branch": "${GITHUB_REF_NAME}",
            "run": ${GITHUB_RUN_NUMBER},
            "xcode": "$XCODE_VER",
            "swift": "$SWIFT_VER",
            "sdk": "$SDK_VER"
          }
EOF

      - name: Push Repository Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/apps.json
          git commit -m "docs: update repository source for v${{ needs.check-version.outputs.version }} (Build ${{ needs.check-version.outputs.build_number }})" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

      # =========================================================
      # Upload Artifacts
      # =========================================================
      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-metadata
          path: |
            release-body.md
            build-metadata.json
            commits.md

      # =========================================================
      # Release
      # =========================================================
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}-build${{ env.BUILD_NUM }}
          name: "Nezu App v${{ env.VERSION }} (Build ${{ env.BUILD_NUM }})"
          body_path: release-body.md
          draft: true
          files: ${{ env.IPA_NAME }}

      # =========================================================
      # Summary
      # =========================================================
      - name: Job Summary
        run: |
          {
            echo "# ✅ Build Completed"
            echo ""
            echo "- **Version:** v${VERSION} (Build ${BUILD_NUM})"
            echo "- **IPA:** \`$IPA_NAME\`"
            echo "- **SHA256:** \`$SHA256\`"
          } >> $GITHUB_STEP_SUMMARY

  # ===========================================================
  # Step 3: Skip notification
  # ===========================================================
  skip-notice:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip Summary
        run: |
          {
            echo "# ⏭️ Build Skipped"
            echo ""
            echo "Version unchanged (v${{ needs.check-version.outputs.version }}, build ${{ needs.check-version.outputs.build_number }})."
            echo "Update \`Version.xcconfig\` in \`test-app/\` to trigger a new build."
          } >> $GITHUB_STEP_SUMMARY
