name: Build Unsigned IPA

on:
  push:
    branches: [main, master]
    paths:
      - "test-app/**"
      - ".github/workflows/build-unsigned-ipa.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ===========================================================
  # Step 1: Check if version changed
  # ===========================================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      build_number: ${{ steps.check.outputs.build_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for version change
        id: check
        run: |
          set -e
          V_CONFIG="test-app/Version.xcconfig"

          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          CURRENT_VERSION=$(grep 'MARKETING_VERSION' "$V_CONFIG" | cut -d'=' -f2 | xargs)
          CURRENT_BUILD=$(grep 'CURRENT_PROJECT_VERSION' "$V_CONFIG" | cut -d'=' -f2 | xargs)

          echo "Current version: $CURRENT_VERSION (build $CURRENT_BUILD)"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$CURRENT_BUILD" >> $GITHUB_OUTPUT

          # workflow_dispatch ã®å ´åˆã¯å¸¸ã«ãƒ“ãƒ«ãƒ‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger â€” building"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # å‰å›žã®ã‚³ãƒŸãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          if git show HEAD~1:"$V_CONFIG" > /dev/null 2>&1; then
            PREV_VERSION=$(git show HEAD~1:"$V_CONFIG" | grep 'MARKETING_VERSION' | cut -d'=' -f2 | xargs)
            PREV_BUILD=$(git show HEAD~1:"$V_CONFIG" | grep 'CURRENT_PROJECT_VERSION' | cut -d'=' -f2 | xargs)
            echo "Previous version: $PREV_VERSION (build $PREV_BUILD)"

            if [ "$CURRENT_VERSION" != "$PREV_VERSION" ] || [ "$CURRENT_BUILD" != "$PREV_BUILD" ]; then
              echo "Version changed: $PREV_VERSION.$PREV_BUILD -> $CURRENT_VERSION.$CURRENT_BUILD"
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "Version unchanged â€” skipping build"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous commit for Version.xcconfig â€” building"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # ===========================================================
  # Step 2: Build (only if version changed)
  # ===========================================================
  build:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: macos-latest

    steps:
      # =========================================================
      # Checkout
      # =========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # =========================================================
      # Xcode
      # =========================================================
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.1"

      - name: Xcode info
        run: |
          xcodebuild -version
          swift --version || true

      # =========================================================
      # Cache
      # =========================================================
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: deriveddata-v2-${{ runner.os }}-${{ hashFiles('test-app/**/*.swift') }}
          restore-keys: |
            deriveddata-v2-${{ runner.os }}-

      # =========================================================
      # Build
      # =========================================================
      - name: Build unsigned app
        run: |
          set -euxo pipefail
          cd test-app

          if ls *.xcworkspace >/dev/null 2>&1; then
            TARGET_FILE=$(ls *.xcworkspace | head -n1)
            SCHEME=$(xcodebuild -list -workspace "$TARGET_FILE" | awk '/Schemes:/ {getline; gsub(/^[ \t]+|[ \t]+$/, ""); print}')
            TARGET_ARGS=(-workspace "$TARGET_FILE")
          else
            TARGET_FILE="nezu-app.xcodeproj"
            SCHEME=$(xcodebuild -list -project "$TARGET_FILE" | awk '/Schemes:/ {getline; gsub(/^[ \t]+|[ \t]+$/, ""); print}')
            TARGET_ARGS=(-project "$TARGET_FILE")
          fi

          echo "Scheme: $SCHEME"

          xcodebuild \
            "${TARGET_ARGS[@]}" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            ONLY_ACTIVE_ARCH=YES \
            -quiet \
            build

      # =========================================================
      # Find App
      # =========================================================
      - name: Locate .app
        id: find_app
        run: |
          set -e
          APP_PATH=$(find DerivedData -name "*.app" | head -n1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app: $APP_PATH"

      # =========================================================
      # Create IPA
      # =========================================================
      - name: Create IPA
        id: create_ipa
        run: |
          set -e
          APP_PATH="${{ steps.find_app.outputs.APP_PATH }}"
          APP_NAME=$(basename "$APP_PATH" .app)
          VERSION="${{ needs.check-version.outputs.version }}"
          BUILD_NUM="${{ needs.check-version.outputs.build_number }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          IPA_NAME="${APP_NAME}-v${VERSION}-build${BUILD_NUM}-${SHORT_SHA}.ipa"

          zip -qr "$IPA_NAME" Payload
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_ENV
          echo "Created $IPA_NAME"

      # =========================================================
      # Verify IPA
      # =========================================================
      - name: Verify IPA
        run: |
          unzip -l "$IPA_NAME" | grep Payload

      # =========================================================
      # Metadata & Repository Update
      # =========================================================
      - name: Generate metadata & Update Repo
        run: |
          set -e
          IPA="$IPA_NAME"

          SIZE_BYTES=$(stat -f%z "$IPA")
          SIZE_HUMAN=$(du -h "$IPA" | cut -f1)
          SHA256=$(shasum -a 256 "$IPA" | awk '{print $1}')

          echo "IPA_SIZE_BYTES=$SIZE_BYTES" >> $GITHUB_ENV
          echo "IPA_SIZE_HUMAN=$SIZE_HUMAN" >> $GITHUB_ENV
          echo "IPA_SHA256=$SHA256" >> $GITHUB_ENV

          # URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸ URL ã‚‚ç”Ÿæˆ (SideStore ç›´æŽ¥ãƒªãƒ³ã‚¯ç”¨)
          DIRECT_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}-build${BUILD_NUM}/${IPA_NAME}"
          ENCODED_URL=$(echo -n "$DIRECT_URL" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")
          echo "ENCODED_URL=$ENCODED_URL" >> $GITHUB_ENV

          XCODE_VER=$(xcodebuild -version | head -n1)
          SWIFT_VER=$(swift --version 2>/dev/null | head -n1 || echo "unknown")
          SDK_VER=$(xcodebuild -showsdks 2>/dev/null | grep -i iphoneos | head -n1 | sed 's/.*iphoneos//' || echo "unknown")

          git log -10 --pretty=format:'- `%h` %ad **%an**: %s' --date=short > commits.md

          # ãƒªãƒã‚¸ãƒˆãƒª JSON ã‚’æ›´æ–°
          python3 scripts/update_apps_json.py "$VERSION" "$BUILD_NUM" "$DIRECT_URL" "$SIZE_BYTES" "$SHA256"

          # ãƒªãƒªãƒ¼ã‚¹æœ¬æ–‡ã®ä½œæˆ (ãƒãƒƒã‚¯ãƒ†ã‚£ãƒƒã‚¯ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ç¢ºå®Ÿã«è¡¨ç¤ºã•ã›ã‚‹)
          cat > release-body.md <<EOF
          ## Nezu App v${VERSION} (Build ${BUILD_NUM})

          - **Version**: \`${VERSION}\`
          - **Build**: \`${BUILD_NUM}\`
          - **Commit**: \`${{ github.sha }}\`
          - **Branch**: \`${{ github.ref_name }}\`
          - **Run**: #${{ github.run_number }}
          - **IPA File**: \`$IPA_NAME\`
          - **IPA Size**: $SIZE_HUMAN ($SIZE_BYTES bytes)
          - **IPA SHA256**: \`$SHA256\`

          ### ðŸ“² ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Source Repository)

          > [!IMPORTANT]
          > ã“ã®ã‚¢ãƒ—ãƒªã‚’å¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã«ä¿ã¤ã«ã¯ã€ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã«è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

          **SideStore / AltStore ç”¨:**
          \`\`\`text
          https://nezumi0627.github.io/nezu-app/apps.json
          \`\`\`

          **LiveContainer ç”¨:**
          \`\`\`text
          livecontainer://source?url=aHR0cHM6Ly9uZXp1bWkwNjI3LmdpdGh1Yi5pby9uZXp1LWFwcC9hcHBzLmpzb24=
          \`\`\`

          ### ðŸ—ï¸ æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Copy & Paste)

          > [!NOTE]
          > ç‰¹åˆ¥ã«ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ç­‰ã§é–‹ã„ã¦ãã ã•ã„ã€‚

          **SideStore ç”¨:**
          \`\`\`text
          sidestore://install?url=$ENCODED_URL
          \`\`\`

          ### Build Environment

          - **Xcode Version**: $XCODE_VER
          - **iOS SDK Version**: $SDK_VER
          - **Swift Version**: $SWIFT_VER

          ### Commits included in this build (latest 10)

          $(cat commits.md)

          **æ³¨æ„**: ã“ã®IPAã¯ç½²åç„¡ã—ã§ã™ã€‚å…¬é–‹ãƒªãƒªãƒ¼ã‚¹å¾Œã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚
          EOF

          cat > build-metadata.json <<EOF
          {
            "version": "$VERSION",
            "build": "$BUILD_NUM",
            "ipa": "$IPA_NAME",
            "size_bytes": $SIZE_BYTES,
            "sha256": "$SHA256",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "run": ${{ github.run_number }},
            "xcode": "$XCODE_VER",
            "swift": "$SWIFT_VER",
            "sdk": "$SDK_VER"
          }
          EOF

      - name: Push Repository Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/apps.json
          git commit -m "docs: update repository source for v${VERSION} (Build ${BUILD_NUM})" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

      # =========================================================
      # Upload Artifacts
      # =========================================================
      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-metadata
          path: |
            release-body.md
            build-metadata.json
            commits.md

      # =========================================================
      # Release
      # =========================================================
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}-build${{ env.BUILD_NUM }}
          name: "Nezu App v${{ env.VERSION }} (Build ${{ env.BUILD_NUM }})"
          body_path: release-body.md
          draft: true
          files: ${{ env.IPA_NAME }}

      # =========================================================
      # Summary
      # =========================================================
      - name: Job Summary
        run: |
          {
            echo "# âœ… Build Completed"
            echo ""
            echo "- **Version:** v${VERSION} (Build ${BUILD_NUM})"
            echo "- **IPA:** \`$IPA_NAME\`"
            echo "- **Size:** $IPA_SIZE_HUMAN"
            echo "- **SHA256:** \`$IPA_SHA256\`"
          } >> $GITHUB_STEP_SUMMARY

  # ===========================================================
  # Step 3: Skip notification
  # ===========================================================
  skip-notice:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip Summary
        run: |
          {
            echo "# â­ï¸ Build Skipped"
            echo ""
            echo "Version unchanged (v${{ needs.check-version.outputs.version }}, build ${{ needs.check-version.outputs.build_number }})."
            echo "Update \`Version.xcconfig\` in \`test-app/\` to trigger a new build."
          } >> $GITHUB_STEP_SUMMARY
