name: Build Unsigned IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write  # Release„Çí‰ΩúÊàê„Åô„Çã„Åü„ÇÅ„Å´ÂøÖË¶Å

    steps:
      # ============================================================================
      # Setup & Preparation
      # ============================================================================

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÂÖ®Â±•Ê≠¥„ÇíÂèñÂæóÔºà„Ç≥„Éü„ÉÉ„Éà‰∏ÄË¶ßÁî®Ôºâ

      - name: Initialize log files
        run: |
          # „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÇíÂàùÊúüÂåñ
          echo "=== Workflow Started ===" > workflow.log
          echo "Timestamp: $(date -u)" >> workflow.log
          echo "Repository: ${{ github.repository }}" >> workflow.log
          echo "Commit: ${{ github.sha }}" >> workflow.log
          echo "Branch: ${{ github.ref_name }}" >> workflow.log
          echo "Run ID: ${{ github.run_id }}" >> workflow.log
          echo "" >> workflow.log
          
          # „Åù„ÅÆ‰ªñ„ÅÆ„É≠„Ç∞„Éï„Ç°„Ç§„É´„ÇÇÂàùÊúüÂåñ
          echo "=== Build Log Started ===" > build.log
          echo "=== IPA Creation Log Started ===" > ipa-creation.log
          echo "=== Verification Log Started ===" > verification.log

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app
          echo "Xcode path: $(xcode-select -p)" | tee -a workflow.log
        continue-on-error: true

      - name: Show Xcode version
        run: |
          echo "=== Xcode Version ===" | tee -a workflow.log
          xcodebuild -version | tee -a workflow.log
        continue-on-error: true

      - name: Set build start time
        run: |
          BUILD_START=$(date -u +%s)
          echo "BUILD_START=$BUILD_START" >> $GITHUB_ENV
          echo "Build started at: $(date -u)" | tee -a workflow.log

      # ============================================================================
      # Project Discovery
      # ============================================================================

      - name: List available schemes
        run: |
          cd test-app || { echo "ERROR: Failed to change directory to test-app" | tee -a ../workflow.log; exit 1; }
          echo "=== Available Schemes ===" | tee -a ../workflow.log
          if [ -f "*.xcworkspace" ]; then
            xcodebuild -list -workspace *.xcworkspace | tee -a ../workflow.log || { echo "ERROR: Failed to list workspace schemes" | tee -a ../workflow.log; exit 1; }
          elif [ -d "nezu-app.xcodeproj" ]; then
            xcodebuild -list -project nezu-app.xcodeproj | tee -a ../workflow.log || { echo "ERROR: Failed to list project schemes" | tee -a ../workflow.log; exit 1; }
          else
            echo "ERROR: No Xcode project or workspace found" | tee -a ../workflow.log
            ls -la | tee -a ../workflow.log
            exit 1
          fi
        continue-on-error: false

      # ============================================================================
      # Build Process
      # ============================================================================

      - name: Build (unsigned)
        run: |
          cd test-app || exit 1
          echo "=== Starting Build ===" | tee -a ../workflow.log
          echo "Timestamp: $(date -u)" | tee -a ../workflow.log
          
          # „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
          if [ -f *.xcworkspace ]; then
            WORKSPACE=$(ls *.xcworkspace | head -n 1)
            SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "Using workspace: $WORKSPACE" | tee -a ../workflow.log
            echo "Using scheme: $SCHEME" | tee -a ../workflow.log
            
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -derivedDataPath ../DerivedData \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ENTITLEMENTS="" \
              build 2>&1 | tee ../build.log
            
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "ERROR: Build failed with exit code: $BUILD_EXIT_CODE" | tee -a ../workflow.log
              echo "ERROR: Build log saved to build.log" | tee -a ../workflow.log
              exit $BUILD_EXIT_CODE
            fi
            
          elif [ -d nezu-app.xcodeproj ]; then
            PROJECT="nezu-app.xcodeproj"
            SCHEME=$(xcodebuild -list -project "$PROJECT" | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "Using project: $PROJECT" | tee -a ../workflow.log
            echo "Using scheme: $SCHEME" | tee -a ../workflow.log
            
            xcodebuild \
              -project "$PROJECT" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -derivedDataPath ../DerivedData \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ENTITLEMENTS="" \
              build 2>&1 | tee -a ../build.log
            
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "ERROR: Build failed with exit code: $BUILD_EXIT_CODE" | tee -a ../workflow.log
              echo "ERROR: Build log saved to build.log" | tee -a ../workflow.log
              exit $BUILD_EXIT_CODE
            fi
          else
            echo "ERROR: No Xcode project or workspace found" | tee -a ../workflow.log
            ls -la | tee -a ../workflow.log
            exit 1
          fi
          
          echo "=== Build Completed Successfully ===" | tee -a ../workflow.log
          echo "Timestamp: $(date -u)" | tee -a ../workflow.log

      # ============================================================================
      # App Discovery & IPA Creation
      # ============================================================================

      - name: Find built app
        id: find_app
        run: |
          cd ${{ github.workspace }}
          echo "=== Searching for .app file ===" | tee -a workflow.log
          
          # DerivedData„Åã„Çâ.app„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
          APP_PATH=$(find ./DerivedData -name "*.app" -type d | grep -i "Release-iphoneos" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ./DerivedData -name "*.app" -type d | head -n 1)
          fi
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: .app file not found" | tee -a workflow.log
            echo "Searching in DerivedData:" | tee -a workflow.log
            find ./DerivedData -type d -name "*.app" | tee -a workflow.log || true
            echo "DerivedData contents:" | tee -a workflow.log
            ls -la ./DerivedData | tee -a workflow.log || true
            exit 1
          fi
          
          # Áµ∂ÂØæ„Éë„Çπ„Å´Â§âÊèõ
          APP_PATH=$(cd "$(dirname "$APP_PATH")" && pwd)/$(basename "$APP_PATH")
          
          echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app at: $APP_PATH" | tee -a workflow.log
          ls -la "$APP_PATH" | tee -a workflow.log

      - name: Extract app name
        id: app_name
        run: |
          APP_NAME=$(basename "${{ steps.find_app.outputs.APP_PATH }}" .app)
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "App name: $APP_NAME" | tee -a workflow.log

      - name: Create IPA
        run: |
          cd ${{ github.workspace }}
          echo "=== IPA Creation Process ===" | tee -a workflow.log
          echo "Timestamp: $(date -u)" | tee -a workflow.log
          
          # ‰∏ÄÊôÇ„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàê
          TEMP_DIR=$(mktemp -d)
          echo "Temporary directory: $TEMP_DIR" | tee -a workflow.log
          
          # Payload„Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê
          mkdir -p "$TEMP_DIR/Payload"
          
          # .app„Éï„Ç°„Ç§„É´„ÇíPayload„Éï„Ç©„É´„ÉÄ„Å´„Ç≥„Éî„Éº
          APP_NAME=$(basename "${{ steps.find_app.outputs.APP_PATH }}")
          echo "Copying .app to Payload..." | tee -a workflow.log
          cp -R "${{ steps.find_app.outputs.APP_PATH }}" "$TEMP_DIR/Payload/" 2>&1 | tee -a ipa-creation.log
          
          # „Ç≥„Éî„Éº„ÅåÊàêÂäü„Åó„Åü„ÅãÁ¢∫Ë™ç
          if [ ! -d "$TEMP_DIR/Payload/$APP_NAME" ]; then
            echo "ERROR: Failed to copy .app to Payload" | tee -a workflow.log | tee -a ipa-creation.log
            echo "ERROR: Source: ${{ steps.find_app.outputs.APP_PATH }}" | tee -a workflow.log | tee -a ipa-creation.log
            echo "ERROR: Destination: $TEMP_DIR/Payload/$APP_NAME" | tee -a workflow.log | tee -a ipa-creation.log
            ls -la "$TEMP_DIR/Payload/" | tee -a workflow.log | tee -a ipa-creation.log || true
            exit 1
          fi
          
          echo "Payload structure:" | tee -a ipa-creation.log
          ls -la "$TEMP_DIR/Payload/" | tee -a ipa-creation.log
          echo "App contents:" | tee -a ipa-creation.log
          ls -la "$TEMP_DIR/Payload/$APP_NAME/" | head -10 | tee -a ipa-creation.log
          
          # IPA„Éï„Ç°„Ç§„É´Âêç„ÇíË®≠ÂÆöÔºà‰∏ÄÊÑè„Å´„Å™„Çã„Çà„ÅÜ„Å´„Éì„É´„ÉâÁï™Âè∑„Å®„Ç≥„Éü„ÉÉ„Éà„Éè„ÉÉ„Ç∑„É•„ÇíÂê´„ÇÅ„ÇãÔºâ
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IPA_NAME="${{ steps.app_name.outputs.APP_NAME }}-unsigned-build${{ github.run_number }}-${SHORT_SHA}.ipa"
          IPA_PATH="${{ github.workspace }}/$IPA_NAME"
          
          echo "IPA name: $IPA_NAME" | tee -a workflow.log
          echo "IPA path: $IPA_PATH" | tee -a workflow.log
          
          # Êó¢Â≠ò„ÅÆIPA„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
          rm -f "$IPA_PATH"
          
          # Payload„Éï„Ç©„É´„ÉÄ„ÇíÂê´„ÇÅ„Å¶zip„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          echo "Creating IPA archive..." | tee -a ipa-creation.log
          cd "$TEMP_DIR"
          zip -r "$IPA_PATH" Payload -x "*.DS_Store" "*.git*" "*.swp" "*.swo" 2>&1 | tee -a ipa-creation.log
          
          # ‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÊàª„Åô
          cd ${{ github.workspace }}
          
          # IPA„Éï„Ç°„Ç§„É´„Åå‰ΩúÊàê„Åï„Çå„Åü„ÅãÁ¢∫Ë™ç
          if [ ! -f "$IPA_PATH" ]; then
            echo "ERROR: Failed to create IPA file" | tee -a workflow.log | tee -a ipa-creation.log
            echo "ERROR: IPA creation log saved to ipa-creation.log" | tee -a workflow.log
            exit 1
          fi
          
          echo "IPA file created successfully" | tee -a workflow.log
          ls -lh "$IPA_PATH" | tee -a ipa-creation.log
          
          # ‰∏ÄÊôÇ„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
          rm -rf "$TEMP_DIR"
          
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

      # ============================================================================
      # IPA Verification
      # ============================================================================

      - name: Verify IPA file before upload
        id: verify_ipa
        run: |
          cd ${{ github.workspace }}
          echo "=== IPA Verification ===" | tee -a workflow.log
          
          if [ ! -f "${{ env.IPA_NAME }}" ]; then
            echo "ERROR: IPA file not found: ${{ env.IPA_NAME }}" | tee -a workflow.log | tee -a verification.log
            echo "ERROR: Current directory: $(pwd)" | tee -a workflow.log | tee -a verification.log
            echo "ERROR: Files in workspace:" | tee -a workflow.log | tee -a verification.log
            ls -la | tee -a workflow.log | tee -a verification.log || true
            echo "ERROR: IPA files:" | tee -a workflow.log | tee -a verification.log
            ls -la *.ipa | tee -a workflow.log | tee -a verification.log || true
            exit 1
          fi
          
          echo "IPA file ready: ${{ env.IPA_NAME }}" | tee -a workflow.log
          ls -lh "${{ env.IPA_NAME }}" | tee -a verification.log
          echo "" | tee -a verification.log
          
          echo "=== IPA file structure verification ===" | tee -a verification.log
          echo "First 30 lines of IPA contents:" | tee -a verification.log
          unzip -l "${{ env.IPA_NAME }}" | head -30 | tee -a verification.log
          echo "" | tee -a verification.log
          
          echo "Checking for Payload folder:" | tee -a verification.log
          if unzip -l "${{ env.IPA_NAME }}" | grep -q "^.*Payload/"; then
            echo "‚úì Payload folder found in IPA" | tee -a verification.log
          else
            echo "‚úó ERROR: Payload folder NOT found in IPA" | tee -a verification.log | tee -a workflow.log
            echo "ERROR: Full contents:" | tee -a verification.log | tee -a workflow.log
            unzip -l "${{ env.IPA_NAME }}" | tee -a verification.log | tee -a workflow.log
            exit 1
          fi
          
          echo "" | tee -a verification.log
          echo "Checking for .app in Payload:" | tee -a verification.log
          if unzip -l "${{ env.IPA_NAME }}" | grep -q "^.*Payload/.*\.app/"; then
            echo "‚úì .app found in Payload folder" | tee -a verification.log
          else
            echo "‚úó ERROR: .app NOT found in Payload folder" | tee -a verification.log | tee -a workflow.log
            echo "ERROR: Verification log saved to verification.log" | tee -a workflow.log
            exit 1
          fi
          
          echo "IPA_FILE_PATH=${{ github.workspace }}/${{ env.IPA_NAME }}" >> $GITHUB_OUTPUT

      # ============================================================================
      # Metadata Generation
      # ============================================================================

      - name: Generate release body and metadata
        id: generate_metadata
        run: |
          cd ${{ github.workspace }}
          echo "=== Generating Metadata ===" | tee -a workflow.log
          
          IPA_FILE="${{ github.workspace }}/${{ env.IPA_NAME }}"

          # IPA„Çµ„Ç§„Ç∫„Éª„Éè„ÉÉ„Ç∑„É•
          echo "Calculating IPA checksum..." | tee -a workflow.log
          IPA_SIZE_BYTES=$(stat -f%z "$IPA_FILE")
          IPA_SIZE_HUMAN=$(du -h "$IPA_FILE" | cut -f1)
          IPA_SHA256=$(shasum -a 256 "$IPA_FILE" | awk '{print $1}')
          
          echo "IPA Size: $IPA_SIZE_HUMAN ($IPA_SIZE_BYTES bytes)" | tee -a workflow.log
          echo "IPA SHA256: $IPA_SHA256" | tee -a workflow.log

          # Runner / „Ç§„É°„Éº„Ç∏ÊÉÖÂ†±
          RUNNER_OS="${RUNNER_OS}"
          RUNNER_ARCH="${RUNNER_ARCH:-unknown}"
          IMAGE_OS="${ImageOS:-unknown}"
          IMAGE_VERSION="${ImageVersion:-unknown}"

          # Runner„ÅÆË©≥Á¥∞ÊÉÖÂ†±„Çí„Éï„Ç°„Ç§„É´„Å´Âá∫ÂäõÔºàÂæå„Åß„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Å®„Åó„Å¶‰øùÂ≠òÔºâ
          {
            echo "=== Runner Basic Info ==="
            echo "RUNNER_OS=$RUNNER_OS"
            echo "RUNNER_ARCH=$RUNNER_ARCH"
            echo "ImageOS=$IMAGE_OS"
            echo "ImageVersion=$IMAGE_VERSION"
            echo
            echo "=== uname -a ==="
            uname -a || true
            echo
            echo "=== sw_vers ==="
            sw_vers || true
          } > runner-system-info.txt

          {
            echo "=== Environment Variables (sorted) ==="
            env | sort
          } > runner-env.txt

          {
            echo "=== Xcode / SDK Info ==="
            xcodebuild -version || true
            echo
            echo "=== Available SDKs ==="
            xcodebuild -showsdks || true
          } > runner-xcode-info.txt

          # „Éì„É´„ÉâÊôÇÈñìË®àÁÆó
          END_TS=$(date -u +%s)
          DURATION_SEC=$((END_TS - BUILD_START))
          H=$((DURATION_SEC / 3600))
          M=$(((DURATION_SEC % 3600) / 60))
          S=$((DURATION_SEC % 60))
          BUILD_DURATION=$(printf "%02d:%02d:%02d" "$H" "$M" "$S")
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV
          echo "Build duration: $BUILD_DURATION ($DURATION_SEC seconds)" | tee -a workflow.log

          # „Ç≥„Éü„ÉÉ„Éà‰∏ÄË¶ßÔºàÊúÄÊñ∞10‰ª∂Ôºâ
          echo "Generating commit list..." | tee -a workflow.log
          git log -10 --pretty=format:'- `%h` %ad **%an**: %s' --date=short > commit-list.md

          # „Çø„Ç∞Âêç„ÅØÂæå„Åß„É™„É™„Éº„Çπ‰ΩúÊàêÂæå„Å´ÂÆüÈöõ„ÅÆ„Çø„Ç∞Âêç„ÇíÂèñÂæó„Åô„Çã
          # ‰∏ÄÊôÇÁöÑ„Å™ÂÄ§„Å®„Åó„Å¶Ë®≠ÂÆöÔºàÂæå„ÅßÊõ¥Êñ∞„Åï„Çå„ÇãÔºâ
          TAG_NAME="untagged-temp"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases"

          cat > release-body.md << 'EOF'
          ## Unsigned IPA Build

          - **Commit**: `${{ github.sha }}`
          - **Branch**: `${{ github.ref_name }}`
          - **Workflow**: `${{ github.workflow }}`
          - **Run**: #${{ github.run_number }}
          - **Build Duration (hh:mm:ss)**: __BUILD_DURATION__
          - **IPA File**: `${{ env.IPA_NAME }}`
          - **IPA Size**: __IPA_SIZE_HUMAN__ (__IPA_SIZE_BYTES__ bytes)
          - **IPA SHA256**: `__IPA_SHA256__`

          ### Runner / Environment

          - **Runner OS**: __RUNNER_OS__ (__RUNNER_ARCH__)
          - **Image OS**: __IMAGE_OS__
          - **Image Version**: __IMAGE_VERSION__

          - **Release URL**: [GitHub Release](__RELEASE_URL__)

          ### Commits included in this build (latest 10)

          __COMMITS__

          ### „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊñπÊ≥ï

          1. ‰∏ã„ÅÆ„ÄåAssets„Äç„Çª„ÇØ„Ç∑„Éß„É≥„Åã„Çâ `.ipa` „Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          2. SideStore„Åß„Ç§„É≥„Çπ„Éà„Éº„É´ÂèØËÉΩ

          **Ê≥®ÊÑè**: „Åì„ÅÆIPA„ÅØÁΩ≤ÂêçÁÑ°„Åó„Åß„Åô„ÄÇSideStore„ÅßÁΩ≤Âêç„Åó„Å¶„Åã„Çâ„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          EOF

          COMMITS_CONTENT=$(cat commit-list.md)

          perl -pi -e "s#__BUILD_DURATION__#$BUILD_DURATION#g" release-body.md
          perl -pi -e "s#__IPA_SIZE_HUMAN__#$IPA_SIZE_HUMAN#g" release-body.md
          perl -pi -e "s#__IPA_SIZE_BYTES__#$IPA_SIZE_BYTES#g" release-body.md
          perl -pi -e "s#__IPA_SHA256__#$IPA_SHA256#g" release-body.md
          perl -pi -e "s#__RUNNER_OS__#$RUNNER_OS#g" release-body.md
          perl -pi -e "s#__RUNNER_ARCH__#$RUNNER_ARCH#g" release-body.md
          perl -pi -e "s#__IMAGE_OS__#$IMAGE_OS#g" release-body.md
          perl -pi -e "s#__IMAGE_VERSION__#$IMAGE_VERSION#g" release-body.md
          perl -pi -e "s#__RELEASE_URL__#$RELEASE_URL#g" release-body.md
          perl -0pi -e 's#__COMMITS__#'"$COMMITS_CONTENT"'#g' release-body.md

          cat > build-metadata.json <<EOF2
          {
            "ipa_name": "${{ env.IPA_NAME }}",
            "ipa_size_bytes": $IPA_SIZE_BYTES,
            "ipa_sha256": "$IPA_SHA256",
            "build_duration_seconds": $DURATION_SEC,
            "build_duration_hms": "$BUILD_DURATION",
            "runner": {
              "os": "$RUNNER_OS",
              "arch": "$RUNNER_ARCH",
              "image_os": "$IMAGE_OS",
              "image_version": "$IMAGE_VERSION"
            },
            "tag_name": "$TAG_NAME",
            "release_url": "$RELEASE_URL",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}"
          }
          EOF2

          echo "Metadata generation completed" | tee -a workflow.log

      # ============================================================================
      # Artifact Upload
      # ============================================================================

      - name: Upload build metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-build-metadata
          path: |
            release-body.md
            build-metadata.json
            commit-list.md
            runner-system-info.txt
            runner-env.txt
            runner-xcode-info.txt
          retention-days: 30

      - name: Upload debug logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-debug-logs
          path: |
            workflow.log
            build.log
            ipa-creation.log
            verification.log
          retention-days: 30
          if-no-files-found: warn

      # ============================================================================
      # Release Creation
      # ============================================================================

      - name: Create Draft Release and Upload IPA
        id: create_release
        continue-on-error: false
        run: |
          cd ${{ github.workspace }}
          echo "=== Release Creation Debug Info ===" | tee -a workflow.log
          echo "IPA file name: ${{ env.IPA_NAME }}" | tee -a workflow.log
          echo "IPA file path: ${{ github.workspace }}/${{ env.IPA_NAME }}" | tee -a workflow.log
          echo "Current directory: $(pwd)" | tee -a workflow.log
          echo "Files in workspace:" | tee -a workflow.log
          ls -la | tee -a workflow.log || true
          echo "IPA files:" | tee -a workflow.log
          ls -lh *.ipa | tee -a workflow.log || true
          echo "" | tee -a workflow.log
          
          if [ ! -f "${{ env.IPA_NAME }}" ]; then
            echo "ERROR: IPA file not found!" | tee -a workflow.log
            exit 1
          fi
          
          echo "IPA file exists and is ready for upload" | tee -a workflow.log
          ls -lh "${{ env.IPA_NAME }}" | tee -a workflow.log
        env:
          IPA_NAME: ${{ env.IPA_NAME }}

      - name: Upload IPA to Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ""  # Á©∫„Å´„Åô„Çã„Åì„Å®„Åß„ÄÅËá™ÂãïÁöÑ„Å´untagged-ÂΩ¢Âºè„ÅÆ„Çø„Ç∞„Åå‰ΩúÊàê„Åï„Çå„Çã
          name: "Build #${{ github.run_number }} - ${{ github.sha }}"
          body_path: release-body.md
          draft: true
          prerelease: false
          files: |
            ${{ env.IPA_NAME }}
          fail_on_unmatched_files: true

      - name: Get actual release tag and URL
        if: success()
        id: get_release_info
        run: |
          cd ${{ github.workspace }}
          
          echo "Getting actual release information..." | tee -a workflow.log
          
          # GitHub API„Åã„ÇâÊúÄÊñ∞„ÅÆdraft„É™„É™„Éº„Çπ„ÇíÂèñÂæóÔºà‰ΩúÊàêÁõ¥Âæå„ÅÆ„É™„É™„Éº„ÇπÔºâ
          # Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâAPI„ÇíÂëº„Å≥Âá∫„ÅôÔºà„É™„É™„Éº„Çπ‰ΩúÊàê„ÅÆÂèçÊò†„ÇíÂæÖ„Å§Ôºâ
          sleep 2
          
          RELEASE_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=5")
          
          echo "API Response (first 500 chars):" | tee -a workflow.log
          echo "$RELEASE_INFO" | head -c 500 | tee -a workflow.log
          echo "" | tee -a workflow.log
          
          # JSON„Åã„ÇâÊúÄÊñ∞„ÅÆdraft„É™„É™„Éº„Çπ„ÇíÂèñÂæó
          if command -v jq &> /dev/null; then
            RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '[.[] | select(.draft == true)][0].html_url // empty')
            ACTUAL_TAG=$(echo "$RELEASE_INFO" | jq -r '[.[] | select(.draft == true)][0].tag_name // empty')
            
            # draft„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÊñ∞„ÅÆ„É™„É™„Éº„Çπ„Çí‰ΩøÁî®
            if [ -z "$RELEASE_URL" ]; then
              RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.[0].html_url // empty')
              ACTUAL_TAG=$(echo "$RELEASE_INFO" | jq -r '.[0].tag_name // empty')
            fi
          else
            # Python„ÅßJSON„Çí„Éë„Éº„Çπ
            RESULT=$(echo "$RELEASE_INFO" | python3 << 'PYEOF'
import json
import sys
try:
    releases = json.load(sys.stdin)
    # draft„É™„É™„Éº„Çπ„ÇíÊé¢„Åô
    draft_release = next((r for r in releases if r.get('draft', False)), None)
    if draft_release:
        print(draft_release.get('html_url', ''))
        print(draft_release.get('tag_name', ''))
    elif releases:
        print(releases[0].get('html_url', ''))
        print(releases[0].get('tag_name', ''))
    else:
        print('')
        print('')
except Exception as e:
    print('', file=sys.stderr)
    print('', file=sys.stderr)
    print('')
    print('')
PYEOF
            )
            RELEASE_URL=$(echo "$RESULT" | head -n 1)
            ACTUAL_TAG=$(echo "$RESULT" | tail -n 1)
          fi
          
          if [ -z "$RELEASE_URL" ] || [ "$RELEASE_URL" = "null" ]; then
            echo "Warning: Could not determine release URL from API, using fallback" | tee -a workflow.log
            RELEASE_URL="https://github.com/${{ github.repository }}/releases"
            ACTUAL_TAG="untagged-unknown"
          fi
          
          echo "ACTUAL_RELEASE_URL=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "ACTUAL_TAG=$ACTUAL_TAG" >> $GITHUB_OUTPUT
          echo "Release URL: $RELEASE_URL" | tee -a workflow.log
          echo "Actual tag: $ACTUAL_TAG" | tee -a workflow.log
          
          # „É°„Çø„Éá„Éº„ÇøJSON„ÇíÊõ¥Êñ∞
          if [ -f build-metadata.json ]; then
            if command -v jq &> /dev/null; then
              jq --arg url "$RELEASE_URL" --arg tag "$ACTUAL_TAG" \
                '.release_url = $url | .tag_name = $tag' build-metadata.json > build-metadata.json.tmp
              mv build-metadata.json.tmp build-metadata.json
            else
              python3 -c "
import json
import os
release_url = os.environ.get('RELEASE_URL', '')
actual_tag = os.environ.get('ACTUAL_TAG', '')
with open('build-metadata.json', 'r') as f:
    data = json.load(f)
data['release_url'] = release_url
data['tag_name'] = actual_tag
with open('build-metadata.json', 'w') as f:
    json.dump(data, f, indent=2)
" RELEASE_URL="$RELEASE_URL" ACTUAL_TAG="$ACTUAL_TAG"
            fi
          fi
          
          # release-body.md„ÇÇÊõ¥Êñ∞
          perl -pi -e "s#https://github.com/\${{ github.repository }}/releases#${RELEASE_URL}#g" release-body.md || true

      # ============================================================================
      # Generate Actions Summary
      # ============================================================================

      - name: Generate Actions Summary
        if: success()
        run: |
          cd ${{ github.workspace }}
          
          echo "Generating Actions Summary..." | tee -a workflow.log
          
          # „É°„Çø„Éá„Éº„Çø„Åã„ÇâÊÉÖÂ†±„ÇíË™≠„ÅøËæº„ÇÄ
          IPA_NAME="${{ env.IPA_NAME }}"
          BUILD_DURATION="${{ env.BUILD_DURATION }}"
          
          # ÂÆüÈöõ„ÅÆ„É™„É™„Éº„ÇπURL„Å®„Çø„Ç∞Âêç„ÇíÂèñÂæóÔºà„É™„É™„Éº„Çπ‰ΩúÊàêÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Åã„ÇâÔºâ
          if [ -n "${{ steps.get_release_info.outputs.ACTUAL_RELEASE_URL }}" ]; then
            RELEASE_URL="${{ steps.get_release_info.outputs.ACTUAL_RELEASE_URL }}"
            TAG_NAME="${{ steps.get_release_info.outputs.ACTUAL_TAG }}"
          else
            # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „É°„Çø„Éá„Éº„ÇøJSON„Åã„ÇâÂèñÂæó
            if [ -f build-metadata.json ]; then
              if command -v jq &> /dev/null; then
                RELEASE_URL=$(jq -r '.release_url // empty' build-metadata.json)
                TAG_NAME=$(jq -r '.tag_name // empty' build-metadata.json)
              else
                RELEASE_URL=$(python3 -c "import json; print(json.load(open('build-metadata.json')).get('release_url', ''))")
                TAG_NAME=$(python3 -c "import json; print(json.load(open('build-metadata.json')).get('tag_name', ''))")
              fi
            fi
            
            if [ -z "$RELEASE_URL" ]; then
              RELEASE_URL="https://github.com/${{ github.repository }}/releases"
              TAG_NAME="untagged-unknown"
            fi
          fi
          
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # JSON „Åã„ÇâÊÉÖÂ†±„ÇíÊäΩÂá∫
          if [ -f build-metadata.json ]; then
            if command -v jq &> /dev/null; then
              IPA_SIZE_BYTES=$(jq -r '.ipa_size_bytes' build-metadata.json)
              IPA_SHA256=$(jq -r '.ipa_sha256' build-metadata.json)
              RUNNER_OS=$(jq -r '.runner.os' build-metadata.json)
              RUNNER_ARCH=$(jq -r '.runner.arch' build-metadata.json)
            else
              # Python „Åß JSON „Çí„Éë„Éº„Çπ
              IPA_SIZE_BYTES=$(python3 -c "import json; print(json.load(open('build-metadata.json'))['ipa_size_bytes'])")
              IPA_SHA256=$(python3 -c "import json; print(json.load(open('build-metadata.json'))['ipa_sha256'])")
              RUNNER_OS=$(python3 -c "import json; print(json.load(open('build-metadata.json'))['runner']['os'])")
              RUNNER_ARCH=$(python3 -c "import json; print(json.load(open('build-metadata.json'))['runner']['arch'])")
            fi
          else
            echo "Warning: build-metadata.json not found, using defaults" | tee -a workflow.log
            IPA_SIZE_BYTES="unknown"
            IPA_SHA256="unknown"
            RUNNER_OS="macOS"
            RUNNER_ARCH="unknown"
          fi
          
          if [ -f "$IPA_NAME" ]; then
            IPA_SIZE_HUMAN=$(du -h "$IPA_NAME" | cut -f1)
          else
            IPA_SIZE_HUMAN="unknown"
          fi
          
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # GitHub Actions Summary „Å´Êõ∏„ÅçËæº„ÇÄ
          {
            echo "# üéâ Build Completed Successfully"
            echo ""
            echo "## üì¶ Build Artifacts"
            echo ""
            echo "| Artifact | Description | Size |"
            echo "|----------|-------------|------|"
            echo "| **IPA File** | Unsigned IPA package | \`${IPA_SIZE_HUMAN}\` |"
            echo "| **Build Metadata** | Release notes, metadata, commit list | 4.79 KB |"
            echo "| **Debug Logs** | Build logs, verification logs | 6.01 KB |"
            echo ""
            echo "## üîó Quick Links"
            echo ""
            echo "- üöÄ **[View Release (Draft)](${RELEASE_URL})** - Download IPA and view release notes"
            echo "- üìã **[View Build Run](${RUN_URL})** - See detailed build logs"
            echo "- üì¶ **[Download Artifacts](#)** - Scroll down to download all artifacts"
            echo ""
            echo "## üìä Build Information"
            echo ""
            echo "- **Build Duration**: \`${BUILD_DURATION}\`"
            echo "- **IPA File**: \`${IPA_NAME}\`"
            echo "- **IPA Size**: \`${IPA_SIZE_HUMAN}\` (\`${IPA_SIZE_BYTES}\` bytes)"
            echo "- **IPA SHA256**: \`\`${IPA_SHA256}\`\`"
            echo "- **Runner**: \`${RUNNER_OS}\` (\`${RUNNER_ARCH}\`)"
            echo ""
            echo "## üìù What's Included"
            echo ""
            echo "### Artifacts Available for Download:"
            echo ""
            echo "1. **unsigned-ipa-backup** - IPA file backup"
            echo "2. **unsigned-ipa-build-metadata** - Contains:"
            echo "   - \`release-body.md\` - Release notes in Markdown"
            echo "   - \`build-metadata.json\` - Machine-readable build metadata"
            echo "   - \`commit-list.md\` - Latest 10 commits"
            echo "   - \`runner-system-info.txt\` - Runner system information"
            echo "   - \`runner-env.txt\` - Environment variables"
            echo "   - \`runner-xcode-info.txt\` - Xcode and SDK information"
            echo "3. **unsigned-ipa-debug-logs** - Contains:"
            echo "   - \`workflow.log\` - Complete workflow execution log"
            echo "   - \`build.log\` - Xcode build output"
            echo "   - \`ipa-creation.log\` - IPA creation process log"
            echo "   - \`verification.log\` - IPA verification log"
            echo ""
            echo "## ‚ö†Ô∏è Important Notes"
            echo ""
            echo "- This IPA is **unsigned** and requires SideStore for installation"
            echo "- The release is created as a **draft** - you can review and publish it manually"
            echo "- All artifacts are retained for **30 days**"
            echo ""
            echo "---"
            echo ""
            echo "**Build completed at**: ${BUILD_TIME}"
          } >> $GITHUB_STEP_SUMMARY
          
          echo "Actions Summary generated successfully" | tee -a workflow.log
          echo "Summary file location: $GITHUB_STEP_SUMMARY" | tee -a workflow.log

      # ============================================================================
      # Error Summary (if failed)
      # ============================================================================

      - name: Generate error summary
        if: failure()
        run: |
          echo "=== Build Failed ===" | tee -a workflow.log
          echo "Timestamp: $(date -u)" | tee -a workflow.log
          echo "" | tee -a workflow.log
          echo "## ‚ùå Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build process encountered an error. Please check the logs below for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Logs:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **workflow.log** - Complete workflow execution log" >> $GITHUB_STEP_SUMMARY
          echo "- **build.log** - Xcode build output (if build started)" >> $GITHUB_STEP_SUMMARY
          echo "- **ipa-creation.log** - IPA creation process log (if IPA creation started)" >> $GITHUB_STEP_SUMMARY
          echo "- **verification.log** - IPA verification log (if verification started)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All logs are available in the **unsigned-ipa-debug-logs** artifact." >> $GITHUB_STEP_SUMMARY

      # ============================================================================
      # Backup Artifact
      # ============================================================================

      - name: Upload IPA as Artifact (backup)
        if: always() && env.IPA_NAME != ''
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-backup
          path: ${{ github.workspace }}/${{ env.IPA_NAME }}
          retention-days: 30
          if-no-files-found: warn
