name: Build Unsigned IPA

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      # =========================================================
      # Checkout
      # =========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # =========================================================
      # Xcode
      # =========================================================
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.1"

      - name: Xcode info
        run: |
          xcodebuild -version
          xcode-select -p
          swift --version || true

      # =========================================================
      # Cache
      # =========================================================
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: deriveddata-${{ runner.os }}
          restore-keys: |
            deriveddata-

      # =========================================================
      # Build
      # =========================================================
      - name: Build unsigned app
        run: |
          set -euxo pipefail
          cd test-app

          if ls *.xcworkspace >/dev/null 2>&1; then
            TARGET_TYPE="workspace"
            TARGET_FILE=$(ls *.xcworkspace | head -n1)
            SCHEME=$(xcodebuild -list -workspace "$TARGET_FILE" | awk '/Schemes:/ {getline; print}')
            TARGET_ARGS=(-workspace "$TARGET_FILE")
          else
            TARGET_TYPE="project"
            TARGET_FILE="nezu-app.xcodeproj"
            SCHEME=$(xcodebuild -list -project "$TARGET_FILE" | awk '/Schemes:/ {getline; print}')
            TARGET_ARGS=(-project "$TARGET_FILE")
          fi

          echo "Target: $TARGET_TYPE $TARGET_FILE"
          echo "Scheme: $SCHEME"

          xcodebuild \
            "${TARGET_ARGS[@]}" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ../DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            ONLY_ACTIVE_ARCH=YES \
            -quiet \
            build

      # =========================================================
      # Find App
      # =========================================================
      - name: Locate .app
        id: find_app
        run: |
          set -e
          APP_PATH=$(find DerivedData -name "*.app" | head -n1)
          echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app: $APP_PATH"

      # =========================================================
      # Create IPA
      # =========================================================
      - name: Create IPA
        id: create_ipa
        run: |
          set -e
          APP_PATH="${{ steps.find_app.outputs.APP_PATH }}"
          APP_NAME=$(basename "$APP_PATH" .app)

          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IPA_NAME="${APP_NAME}-unsigned-${{ github.run_number }}-${SHORT_SHA}.ipa"

          zip -qr "$IPA_NAME" Payload
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV
          echo "Created $IPA_NAME"

      # =========================================================
      # Verify IPA
      # =========================================================
      - name: Verify IPA
        run: |
          unzip -l "$IPA_NAME" | grep Payload

      # =========================================================
      # Metadata
      # =========================================================
      - name: Generate metadata
        run: |
          set -e
          IPA="$IPA_NAME"

          SIZE_BYTES=$(stat -f%z "$IPA")
          SIZE_HUMAN=$(du -h "$IPA" | cut -f1)
          SHA256=$(shasum -a 256 "$IPA" | awk '{print $1}')

          echo "IPA_SIZE_BYTES=$SIZE_BYTES" >> $GITHUB_ENV
          echo "IPA_SIZE_HUMAN=$SIZE_HUMAN" >> $GITHUB_ENV
          echo "IPA_SHA256=$SHA256" >> $GITHUB_ENV

          git log -10 --pretty=format:'- `%h` %s' > commits.md

          cat > release-body.md <<EOF
          ## Unsigned IPA Build

          - **Commit**: \`${{ github.sha }}\`
          - **Branch**: \`${{ github.ref_name }}\`
          - **Run**: #${{ github.run_number }}
          - **IPA**: \`$IPA_NAME\`
          - **Size**: $SIZE_HUMAN ($SIZE_BYTES bytes)
          - **SHA256**: \`$SHA256\`

          ### Commits
          $(cat commits.md)

          **Note:** This IPA is unsigned. Use SideStore to install.
          EOF

          cat > build-metadata.json <<EOF
          {
            "ipa": "$IPA_NAME",
            "size_bytes": $SIZE_BYTES,
            "sha256": "$SHA256",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "run": ${{ github.run_number }}
          }
          EOF

      # =========================================================
      # Upload Artifacts
      # =========================================================
      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-metadata
          path: |
            release-body.md
            build-metadata.json
            commits.md

      # =========================================================
      # Release
      # =========================================================
      - name: Create draft release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Unsigned IPA Build #${{ github.run_number }}
          body_path: release-body.md
          draft: true
          files: ${{ env.IPA_NAME }}

      # =========================================================
      # Summary
      # =========================================================
      - name: Job Summary
        run: |
          {
            echo "# âœ… Build Completed"
            echo ""
            echo "- **IPA:** \`$IPA_NAME\`"
            echo "- **Size:** $IPA_SIZE_HUMAN"
            echo "- **SHA256:** \`$IPA_SHA256\`"
          } >> $GITHUB_STEP_SUMMARY
