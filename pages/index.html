<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nezu App - IPA ダウンロード</title>
    <meta name="description" content="Nezu App の IPA ファイルをダウンロード">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#111;color:#e8e8e8;line-height:1.5}
        a{color:#6cb4ff;text-decoration:none}
        a:hover{text-decoration:underline}
        .wrap{max-width:760px;margin:0 auto;padding:24px 16px 60px}
        header{padding:32px 0 24px;border-bottom:1px solid #2a2a2a;margin-bottom:24px}
        header h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
        header p{color:#888;font-size:.85rem}
        .stats{display:flex;gap:24px;margin-bottom:28px;flex-wrap:wrap}
        .stats div{font-size:.8rem;color:#888}
        .stats div span{color:#e8e8e8;font-weight:600}
        .card{border:1px solid #2a2a2a;border-radius:8px;padding:16px 20px;margin-bottom:12px;background:#1a1a1a}
        .card.latest{border-color:#3b6ec2}
        .card-top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
        .card-title{font-size:1rem;font-weight:700}
        .badge{display:inline-block;padding:1px 8px;border-radius:4px;font-size:.65rem;font-weight:700;text-transform:uppercase;vertical-align:middle;margin-left:6px}
        .badge-latest{background:#1a3a5c;color:#6cb4ff}
        .badge-pre{background:#3a2a10;color:#d4a04a}
        .dl-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 16px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;text-decoration:none;white-space:nowrap}
        .dl-btn:hover{background:#1d4ed8;text-decoration:none}
        .meta{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;font-size:.78rem}
        .meta dt{color:#666;font-size:.68rem;text-transform:uppercase;letter-spacing:.5px}
        .meta dd{color:#ccc;margin-bottom:4px;word-break:break-all}
        .meta dd.mono{font-family:'SF Mono','Consolas',monospace;font-size:.73rem;color:#7cc}
        details{margin-top:10px;font-size:.78rem}
        details summary{color:#888;cursor:pointer;font-size:.75rem;padding:4px 0}
        details summary:hover{color:#bbb}
        .sha{margin-top:8px;padding:8px 10px;background:#141414;border:1px solid #252525;border-radius:4px;font-family:monospace;font-size:.7rem;color:#7cc;word-break:break-all}
        .commits{margin-top:8px;list-style:none}
        .commits li{padding:3px 0;border-bottom:1px solid #1e1e1e;display:flex;gap:8px}
        .commits li:last-child{border:none}
        .commits code{color:#a78bfa;font-size:.7rem;white-space:nowrap}
        .commits span{color:#999}
        .env-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:4px 12px;margin-top:8px}
        .env-grid dt{color:#666;font-size:.65rem}
        .env-grid dd{color:#aaa;font-size:.75rem;margin-bottom:4px}
        .loading,.error{text-align:center;padding:60px 0;color:#888}
        .error button{margin-top:12px;padding:6px 16px;background:#222;border:1px solid #444;color:#ccc;border-radius:4px;cursor:pointer;font-size:.8rem}
        footer{border-top:1px solid #2a2a2a;padding:20px 0;text-align:center;font-size:.72rem;color:#555}
        footer a{color:#666}
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>Nezu App</h1>
        <p>署名無し IPA ダウンロード — GitHub Actions ビルド</p>
    </header>
    <div class="stats" id="stats">
        <div>リリース: <span id="s-rel">-</span></div>
        <div>総DL数: <span id="s-dl">-</span></div>
        <div>最新: <span id="s-latest">-</span></div>
    </div>
    <div id="app"><div class="loading">読み込み中...</div></div>
    <footer>
        <a href="https://github.com/nezumi0627/nezu-app">GitHub</a> · &copy; 2025 nezumi0627
    </footer>
</div>
<script>
const API='https://api.github.com/repos/nezumi0627/nezu-app/releases';
function fmtBytes(b){if(!b)return'0 B';const u=['B','KB','MB'];const i=Math.floor(Math.log(b)/Math.log(1024));return(b/Math.pow(1024,i)).toFixed(i?1:0)+' '+u[i]}
function fmtDate(s){const d=new Date(s);return d.getFullYear()+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0')+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function ago(s){const days=Math.floor((Date.now()-new Date(s))/864e5);if(days<1)return'今日';if(days===1)return'昨日';if(days<30)return days+'日前';if(days<365)return Math.floor(days/30)+'ヶ月前';return Math.floor(days/365)+'年前'}
function buildNum(t){const m=t.match(/build-(\d+)/);return m?'#'+m[1]:t}
function ver(r){const t=r.tag_name;if(t.startsWith('v'))return t.slice(1);const m=t.match(/build-(\d+)/);return m?'1.0.0 (Build '+m[1]+')':t}
function parse(body,re){if(!body)return null;const m=body.match(re);return m?m[1]:null}
function commits(body){if(!body)return[];const r=[];body.replace(/`([a-f0-9]{7})`\s+\S+\s+\*\*.*?\*\*:\s*(.*)/g,(_,h,msg)=>r.push({h,msg}));return r}
function envInfo(body){if(!body)return{};const g=k=>{const m=body.match(new RegExp(k+'\\*\\*:\\s*(.+?)[\r\n]'));return m?m[1].replace(/`/g,'').trim():null};return{xcode:g('Xcode Version'),sdk:g('iOS SDK Version'),swift:g('Swift Version'),runner:g('Runner OS')}}

async function load(){
 const el=document.getElementById('app');
 try{
  const res=await fetch(API,{headers:{Accept:'application/vnd.github.v3+json'}});
  if(!res.ok)throw new Error('HTTP '+res.status);
  const data=await res.json();
  const list=data.filter(r=>!r.draft&&r.assets.some(a=>a.name.endsWith('.ipa'))).sort((a,b)=>new Date(b.published_at)-new Date(a.published_at));
  const totalDL=list.reduce((s,r)=>s+r.assets.reduce((a,x)=>a+x.download_count,0),0);
  document.getElementById('s-rel').textContent=list.length;
  document.getElementById('s-dl').textContent=totalDL;
  if(list.length)document.getElementById('s-latest').textContent=buildNum(list[0].tag_name);
  if(!list.length){el.innerHTML='<div class="error">リリースなし</div>';return}
  let h='';
  list.forEach((r,i)=>{
   const ipa=r.assets.find(a=>a.name.endsWith('.ipa'));if(!ipa)return;
   const latest=i===0;
   const sha=parse(r.body,/SHA256[`:\s]*`([a-f0-9]{64})`/i);
   const dur=parse(r.body,/Duration.*?(\d{2}:\d{2}:\d{2})/);
   const cm=commits(r.body);
   const env=envInfo(r.body);
   const hash=(ipa.name.match(/([a-f0-9]{7})\.ipa/)||[])[1]||'';
   h+=`<div class="card${latest?' latest':''}"><div class="card-top"><div><span class="card-title">${ver(r)}</span>${latest?'<span class="badge badge-latest">最新</span>':''}${r.prerelease?'<span class="badge badge-pre">Pre</span>':''}</div><a class="dl-btn" href="${ipa.browser_download_url}">⬇ DL (${fmtBytes(ipa.size)})</a></div><dl class="meta"><dt>公開日</dt><dd>${fmtDate(r.published_at)} (${ago(r.published_at)})</dd><dt>ファイル</dt><dd class="mono">${ipa.name}</dd><dt>DL数</dt><dd>${ipa.download_count} 回</dd><dt>タグ</dt><dd class="mono">${r.tag_name}</dd>${dur?'<dt>ビルド時間</dt><dd>'+dur+'</dd>':''}${hash?'<dt>コミット</dt><dd class="mono">'+hash+'</dd>':''}</dl><details><summary>詳細情報</summary>${sha?'<div class="sha">SHA256: '+sha+'</div>':''}${Object.values(env).some(Boolean)?'<dl class="env-grid">'+(env.xcode?'<dt>Xcode</dt><dd>'+env.xcode+'</dd>':'')+(env.sdk?'<dt>iOS SDK</dt><dd>'+env.sdk+'</dd>':'')+(env.swift?'<dt>Swift</dt><dd>'+env.swift+'</dd>':'')+(env.runner?'<dt>Runner</dt><dd>'+env.runner+'</dd>':'')+'</dl>':''}${cm.length?'<ul class="commits">'+cm.slice(0,5).map(c=>'<li><code>'+c.h+'</code><span>'+c.msg+'</span></li>').join('')+'</ul>':''}</details></div>`;
  });
  el.innerHTML=h;
 }catch(e){el.innerHTML='<div class="error">取得失敗: '+e.message+'<br><button onclick="load()">再試行</button></div>'}
}
load();
</script>
</body>
</html>
